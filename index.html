<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Jam Session</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      font-family: sans-serif;
    }

    canvas {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
    }

    .menu {
      position: relative;
      z-index: 10;
      color: white;
      text-align: center;
      padding-top: 20vh;
    }

    .menu a {
      display: inline-block;
      margin: 1rem;
      padding: 1rem 2rem;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      text-decoration: none;
      font-size: 1.5rem;
    }

.chat-bar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  background: rgba(0,0,0,0.6);
  border-radius: 50px;
  padding: 0.4rem 1rem;
  z-index: 20;
  box-shadow: 0 0 10px rgba(0,255,255,0.2);
  backdrop-filter: blur(8px);
}

.chat-bar input {
  border: none;
  background: transparent;
  color: white;
  font-size: 1rem;
  outline: none;
  width: 200px;
}

.chat-bar button {
  background: none;
  border: none;
  color: #0ff;
  font-size: 1.2rem;
  cursor: pointer;
}

    #chat-messages {
      height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      background: rgba(0,0,0,0.5);
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-family: monospace;
      margin-bottom: 1rem;
      text-align: left;
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
    }

    .chat-input input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }

    .chat-input button {
      padding: 0.5rem 1rem;
      background: #00aaff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="menu">
    <h1>ðŸŽ¸ Jam Session</h1>
    <a href="info.html">ðŸ“‹ Infos</a>
    <a href="paroles.html">ðŸŽ¤ Paroles</a>
    <a href="tablatures.html">ðŸŽ¼ Tablatures</a>

    <div class="chat-bar">
  <input type="text" id="chat-input" placeholder="ðŸ’¬ Envoie un message...">
  <button onclick="sendMessage()">âž¤</button>
</div>
  </div>

  <script>
    // ðŸ”¥ Remplace par la vraie config Firebase de ton projet
    const firebaseConfig = {
      apiKey: "TA_CLÃ‰",
      authDomain: "ton-projet.firebaseapp.com",
      databaseURL: "https://ton-projet.firebaseio.com",
      projectId: "ton-projet",
      storageBucket: "ton-projet.appspot.com",
      messagingSenderId: "XXX",
      appId: "1:XXX:web:XXX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

function sendMessage() {
  const input = document.getElementById("chat-input");
  const text = input.value.trim();
  if (!text) return;

  db.ref("chat").push({
    user: "ðŸŽ¤",
    text: text,
    time: Date.now()
  });
  input.value = "";
}

function listenToChat() {
  db.ref("chat").on("child_added", snapshot => {
    const msg = snapshot.val();
    showFloatingMessage(`${msg.user} ${msg.text}`);
  });
}

    window.addEventListener("load", listenToChat);

    // ðŸŽ¶ p5.js visual
    let notes = [];
    let bpm = 90;
    let beatMs = 60000 / bpm;
    let lastClickTime = 0;
    let lastBeat = 0;
    let flashAlpha = 0;

    function setup() {
      createCanvas(windowWidth, windowHeight);
      noStroke();
      textFont('Arial');
      textAlign(CENTER, CENTER);
    }

    function draw() {
      background(0, 60);
      drawSmoothPulse();

      for (let note of notes) {
        note.update();
        note.display();
      }

      if (frameCount % 20 === 0) {
        notes.push(new Note());
      }

      if (notes.length > 100) {
        notes.splice(0, 1);
      }
    }

    function drawSmoothPulse() {
      let t = (millis() - lastBeat) % beatMs;
      let pct = t / beatMs;
      let glow = sin(pct * TWO_PI);
      let size = map(glow, 0, 1, 80, 240);
      let alpha = map(glow, 0, 1, 10, 60);

      push();
      translate(width / 2, height / 2);
      fill(0, 255, 255, alpha);
      ellipse(0, 0, size);
      pop();
    }

    function mousePressed() {
      let now = millis();
      let delta = now - lastClickTime;
      lastClickTime = now;
      let rhythmData = evaluateTiming(delta);
      notes.push(new Note(true, rhythmData.label, rhythmData.color));
    }

    function evaluateTiming(delta) {
      let grid = [
        { label: '1 temps', ms: beatMs },
        { label: 'Â½ temps', ms: beatMs / 2 },
        { label: 'â…“ temps', ms: beatMs / 3 },
        { label: 'Â¼ temps', ms: beatMs / 4 },
        { label: '2 temps', ms: beatMs * 2 }
      ];

      let closest = grid.reduce((a, b) =>
        Math.abs(delta - a.ms) < Math.abs(delta - b.ms) ? a : b
      );

      let relativeError = Math.abs(delta - closest.ms) / closest.ms * 100;

      let color;
      if (relativeError <= 5) {
        color = colorFromHex("#00ff00");
      } else if (relativeError <= 15) {
        color = colorFromHex("#ffff00");
      } else {
        color = colorFromHex("#ff3333");
      }

      let label = `${closest.label} | ${relativeError.toFixed(1)}%`;
      return { label, color };
    }

    function showFloatingMessage(text) {
  const div = document.createElement("div");
  div.textContent = text;
  div.style.position = "fixed";
  div.style.left = `${10 + Math.random() * 80}%`;
  div.style.top = `${20 + Math.random() * 60}%`;
  div.style.color = "white";
  div.style.fontSize = "1.2rem";
  div.style.fontFamily = "sans-serif";
  div.style.padding = "0.5rem 1rem";
  div.style.background = "rgba(0,0,0,0.5)";
  div.style.border = "1px solid #0ff";
  div.style.borderRadius = "20px";
  div.style.zIndex = 15;
  div.style.opacity = 0;
  div.style.transition = "opacity 0.3s";

  document.body.appendChild(div);
  requestAnimationFrame(() => {
    div.style.opacity = 1;
  });

  setTimeout(() => {
    div.style.opacity = 0;
    setTimeout(() => div.remove(), 1000);
  }, 4000);
}

    function colorFromHex(hex) {
      return color(hex);
    }

    class Note {
      constructor(fromClick = false, rhythm = '', customColor = null) {
        this.x = random(width);
        this.y = fromClick ? random(height * 0.4, height * 0.6) : height + 20;
        this.size = fromClick ? 64 : random(24, 48);
        this.speed = fromClick ? 0.8 : random(1.5, 2.5);
        this.alpha = 255;
        this.symbols = ['â™ª', 'â™©', 'â™«', 'â™¬'];
        this.char = random(this.symbols);
        this.color = customColor || color(random(100, 255), random(100, 255), 255);
        this.fromClick = fromClick;
        this.rhythm = rhythm;
      }

      update() {
        this.y -= this.speed;
        this.alpha -= 2;
      }

      display() {
        push();
        textSize(this.size);
        for (let i = 3; i >= 1; i--) {
          fill(red(this.color), green(this.color), blue(this.color), this.alpha / i);
          text(this.char, this.x, this.y);
        }

        if (this.fromClick && this.alpha > 100) {
          textSize(14);
          fill(255, 255, 255, this.alpha);
          text(this.rhythm, this.x, this.y - this.size);
        }
        pop();
      }
    }
  </script>
</body>
</html>
